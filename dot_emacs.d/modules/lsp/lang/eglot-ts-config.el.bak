;;; eglot-ts-config.el --- Eglot configuration for TypeScript -*- lexical-binding: t -*-

;;; Commentary:
;; Eglot configuration specifically for TypeScript / JavaScript

;;; Code:

(use-package eglot
  :ensure t
  :hook
  ((typescript-mode js-mode tsx-ts-mode) . eglot-ensure)

  :config
  ;; -----------------------------
  ;; Detect language servers
  ;; -----------------------------
  (let ((ts-server-found (executable-find "typescript-language-server"))
        (vtsls-found (executable-find "vtsls"))  ; Volta TypeScript Language Server for better Next.js support
        )
    (cond
     ;; Use vtsls if available (better for Next.js/React projects)
     (vtsls-found
      (message "[Eglot] Using vtsls (Volta TypeScript Language Server)")
      (add-to-list 'eglot-server-programs
                   '((typescript-mode js-mode tsx-ts-mode)
                     .
                     ("vtsls" "--stdio")))
      ;; Add tree-sitter support if available
      (when (treesit-available-p)
        (add-hook 'tsx-ts-mode-hook #'eglot-ensure)
        (add-hook 'js-ts-mode-hook #'eglot-ensure)))
     
     ;; Fallback to typescript-language-server
     (ts-server-found
      (message "[Eglot] Using typescript-language-server")
      (add-to-list 'eglot-server-programs
                   '((typescript-mode js-mode tsx-ts-mode)
                     .
                     ("typescript-language-server" "--stdio")))
      ;; Add tree-sitter support if available
      (when (treesit-available-p)
        (add-hook 'tsx-ts-mode-hook #'eglot-ensure)
        (add-hook 'js-ts-mode-hook #'eglot-ensure)))
     
     ;; No server found
     (t
      (message "[Eglot] No TypeScript language server found! Install via: npm i -g typescript-language-server typescript OR npm i -g @volar/vscode-typescript-languageserver"))))

  ;; -----------------------------
  ;; QoL tweaks
  ;; -----------------------------
  (add-hook 'eglot-managed-mode-hook
            (lambda ()
              ;; Inlay hints (Emacs29+)
              (when (fboundp 'eglot-inlay-hints-mode)
                (eglot-inlay-hints-mode 1))

              ;; 避免阻塞
              (setq-local eglot-sync-connect nil)

              ;; 自动重启
              (setq-local eglot-autoshutdown t)

              ;; xref 支持
              (setq-local eglot-extend-to-xref t)

              ;; Format on save for frontend development
              (add-hook 'before-save-hook #'eglot-format-buffer -10 t)
              
              ;; Configure JSX support for React files
              (when (or (string-match "\\.tsx\\'" (or buffer-file-name ""))
                        (string-match "\\.jsx\\'" (or buffer-file-name "")))
                (setq-local eglot-workspace-configuration
                            (append eglot-workspace-configuration
                                    `(:typescript
                                      (:jsxFragmentFactory "React.Fragment")
                                      :javascript
                                      (:jsxFragmentFactory "React.Fragment"))))))))

;; Additional configuration for JSX files
(defun my-eglot-jsx-setup ()
  "Additional setup for JSX/TSX files with Eglot."
  (when (or (eq major-mode 'tsx-ts-mode)
            (eq major-mode 'js-ts-mode)
            (string-match "\\.tsx\\'" (or buffer-file-name ""))
            (string-match "\\.jsx\\'" (or buffer-file-name "")))
    (setq-local eglot-workspace-configuration
                (append eglot-workspace-configuration
                        `(:typescript
                          (:jsxAttrsUsedByJsxPragma "React")
                          :javascript
                          (:jsxAttrsUsedByJsxPragma "React"))))))

(add-hook 'eglot-managed-mode-hook 'my-eglot-jsx-setup)

;; -----------------------------
;; Key bindings
;; -----------------------------
(with-eval-after-load 'eglot
  (define-key eglot-mode-map (kbd "C-c r") 'eglot-rename)
  (define-key eglot-mode-map (kbd "C-c d") 'eldoc)
  (define-key eglot-mode-map (kbd "C-c g d") 'xref-find-definitions)
  (define-key eglot-mode-map (kbd "C-c g r") 'xref-find-references)
  (define-key eglot-mode-map (kbd "C-c a") 'eglot-code-actions)
  (define-key eglot-mode-map (kbd "C-c f") 'eglot-format-buffer))

(provide 'eglot-ts-config)
;;; eglot-ts-config.el ends here